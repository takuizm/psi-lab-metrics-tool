# PSIラボ値取得システム 仕様書

**文書番号**: 20250918_PSIラボ値取得システム_仕様書_v1
**作成日**: 2025年9月18日
**バージョン**: 1.0

## 1. システム概要

### 1.1 目的
- 対象URLのPageSpeed Insights（PSI）ラボデータを自動取得
- Splunk Syntheticの計測結果との比較を可能にする
- 継続的なWebパフォーマンス監視のための基盤を提供

### 1.2 背景
- 現在、WebパフォーマンスをSplunk Syntheticで監視中
- PSIラボデータとの比較・突合せが必要
- ローカル環境でのLighthouse計測では、PSIサーバでの計測結果と乖離が発生
- PSI API経由での正式な計測が必要

### 1.3 システム名称
PSIラボ値取得システム（PSI Lab Metrics Tool）

## 2. 機能仕様

### 2.1 主要機能

#### 2.1.1 PSI API連携機能
- Google PageSpeed Insights API v5を使用してラボデータを取得
- モバイル・デスクトップ両方の計測に対応
- APIキーによる認証機能
- レート制限・クォータ制限への対応

#### 2.1.2 メトリクス取得機能
取得対象メトリクス：
- **Onload**: `observedLoad`（ミリ秒）- window.loadイベント
- **TTFB**: `timeToFirstByte`（ミリ秒）- 初期サーバー応答時間
- **LCP**: `largest-contentful-paint`（ミリ秒）- 最大コンテンツフルペイント
- **CLS**: `cumulative-layout-shift`（数値）- 累積レイアウトシフト
- **Speed Index**: メトリクス値（ミリ秒）- 表示速度指標

#### 2.1.3 データ出力機能
- JSON形式での生データ出力
- CSV形式での集約データ出力（Excel対応）
- タイムスタンプ付きデータ
- デバイス種別（mobile/desktop）の明示

#### 2.1.4 バッチ処理機能
- 複数URLの一括処理（最大1000件想定）
- CSVファイルからのURL読み込み
- 大量URL処理への対応
- 実行結果のログ出力

### 2.2 非機能要件

#### 2.2.1 性能要件
- PSI APIのレート制限内での安定動作
- 1URLあたり最大60秒のタイムアウト設定
- 失敗時のリトライ機能（最大3回）

#### 2.2.2 可用性要件
- PSI APIサービス停止時のエラーハンドリング
- 部分的な失敗時の継続処理
- 処理中断時の安全な停止

#### 2.2.3 保守性要件
- 設定ファイルによるパラメータ管理
- ログ出力による実行状況の追跡
- エラー詳細の記録

## 3. 技術仕様

### 3.1 システムアーキテクチャ

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   設定ファイル    │    │  PSIラボ値取得    │    │  Google PSI API │
│  (config.yaml)  │───▶│     システム      │───▶│      v5         │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │   出力ファイル    │
                       │ (JSON/CSV/LOG)  │
                       └─────────────────┘
```

### 3.2 技術スタック
- **実行環境**: Python 3.8+
- **HTTP クライアント**: `requests` ライブラリ
- **設定管理**: `PyYAML`
- **CSV処理**: `pandas`（大量データ対応）
- **ログ出力**: `logging`
- **CLI**: `click`

### 3.3 モジュール構成

```
src/
├── main.py              # メインエントリポイント・CLI
├── config_manager.py    # 設定管理・環境変数処理
├── csv_loader.py        # CSV読み込み・検証
├── psi_client.py        # PSI API クライアント
├── metrics_extractor.py # メトリクス抽出・変換
└── output_manager.py    # 出力管理・ファイル操作
```

## 4. 入出力仕様

### 4.1 入力仕様

#### 4.1.1 設定ファイル（config/config.yaml）
```yaml
api:
  key: "${PSI_API_KEY}"  # 環境変数から取得
  timeout: 60            # タイムアウト（秒）
  retry_count: 3         # リトライ回数

input:
  targets_csv: "./targets.csv"  # 計測対象URL一覧CSV
  csv_encoding: "utf-8-sig"     # CSVエンコーディング

execution:
  strategies: ["mobile", "desktop"]  # 計測戦略
  parallel: false                     # 並列実行（必要に応じて true ）
  max_workers: 4                      # 並列時の最大ワーカー数

output:
  json_dir: "./output/json"
  csv_file: "./output/csv/psi_metrics.csv"
  log_file: "./logs/execution.log"
```

#### 4.1.2 計測対象CSV（targets.csv）
```csv
url,name,enabled,category,priority
https://www.example.com,サンプルサイト,true,企業サイト,high
https://www.google.com,Google,true,検索エンジン,medium
```

**必須カラム:**
- `url`: 計測対象URL
- `name`: サイト名

**オプションカラム:**
- `enabled`: 計測有効/無効（true/false）
- `category`: サイトカテゴリ
- `priority`: 優先度（high/medium/low）

### 4.2 出力仕様

#### 4.2.1 CSV出力
ファイル名: `psi_metrics.csv`
```csv
site_name,url,strategy,timestamp,onload_ms,ttfb_ms,lcp_ms,cls,speed_index_ms
Google,https://www.google.com,mobile,2025-09-18T10:30:00Z,1500,200,2000,0.05,1800
Google,https://www.google.com,desktop,2025-09-18T10:31:00Z,800,150,1000,0.02,900
```

#### 4.2.2 JSON出力
ファイル名: `{サイト名}_{strategy}_{YYYYMMDD_HHMMSS}.json`
- PSI APIの完全なレスポンスデータ
- Lighthouse詳細情報を含む

## 5. API仕様

### 5.1 PageSpeed Insights API v5

#### 5.1.1 エンドポイント
```
GET https://www.googleapis.com/pagespeedonline/v5/runPagespeed
```

#### 5.1.2 リクエストパラメータ
| パラメータ | 必須 | 型 | 説明 |
|-----------|-----|----|----|
| url | ○ | string | 計測対象URL（URLエンコード必要） |
| key | ○ | string | PSI APIキー |
| strategy | × | string | 'mobile' または 'desktop' |
| category | × | string | 'performance'（固定） |
| locale | × | string | 'ja'（日本語） |

#### 5.1.3 レスポンス構造
```json
{
  "lighthouseResult": {
    "audits": {
      "metrics": {
        "details": {
          "items": [{
            "observedLoad": 1995,
            "timeToFirstByte": 601,
            "observedLargestContentfulPaint": 1404
          }]
        }
      },
      "largest-contentful-paint": {
        "numericValue": 13344.0
      },
      "cumulative-layout-shift": {
        "numericValue": 0.0535
      }
    }
  }
}
```

## 6. Splunk Syntheticとの比較仕様

### 6.1 メトリクス対応表
| Splunk Synthetic | PSI API | 説明 |
|------------------|---------|------|
| Onload time | observedLoad | window.loadイベント |
| TTFB | timeToFirstByte | 初期サーバー応答時間 |
| - | LCP | 最大コンテンツフルペイント |
| - | CLS | 累積レイアウトシフト |

### 6.2 条件差異の考慮事項
- **Splunk**: Mobile LTE（12Mbps/70ms）
- **PSI**: モバイル（1.6Mbps/150ms/CPU 4x）
- 計測地点・ネットワーク条件の違いによる値の差異は正常

## 7. エラーハンドリング仕様

### 7.1 PSI API エラー
- **429 (Rate Limit)**: 指数バックオフでリトライ
- **403 (Forbidden)**: APIキー・権限エラーとして終了
- **400 (Bad Request)**: パラメータエラーとして記録・スキップ
- **5xx (Server Error)**: サーバエラーとしてリトライ

### 7.2 実行時エラー
- ネットワーク接続エラー
- タイムアウトエラー
- JSON解析エラー
- ファイル書き込みエラー

### 7.3 大量データ処理
- メモリ効率化のためのチャンク処理
- 進捗表示機能
- 中断時の安全な停止

## 8. ログ仕様

### 8.1 ログレベル
- **INFO**: 実行開始・終了、成功時の情報
- **WARN**: リトライ実行、部分的な失敗
- **ERROR**: API エラー、システムエラー
- **DEBUG**: 詳細な実行情報（開発時）

### 8.2 ログフォーマット
```
2025-09-18 10:30:00 [INFO] Starting PSI metrics collection
2025-09-18 10:30:01 [INFO] Processing: https://www.example.com
2025-09-18 10:30:15 [INFO] Successfully collected: onload=1500ms, ttfb=200ms
2025-09-18 10:30:16 [ERROR] API Error 429: Rate limit exceeded, retrying
```

## 9. セキュリティ仕様

### 9.1 APIキー管理
- 環境変数または設定ファイルでの管理
- バージョン管理システムへの機密情報の非含有
- APIキーの定期的な更新推奨

### 9.2 出力データ
- 個人情報を含まないパフォーマンスメトリクスのみ
- 出力ファイルの適切な権限設定

## 10. 運用仕様

### 10.1 実行方法
- 手動実行: `run.bat` / `run.sh` のダブルクリック
- 自動実行: cron/タスクスケジューラでの定期実行
- コマンドライン: `python -m src.main --strategy both`
- 設定確認のみ: `python -m src.main --dry-run`
- 一時的なターゲット差し替え: `python -m src.main --targets-csv ./tmp/targets_test.csv`

### 10.2 監視・メンテナンス
- 実行ログの定期的な確認
- APIクォータ使用量の監視
- 古いファイルの自動クリーンアップ（30日）

### 10.3 大量データ処理仕様
- **想定規模**: 最大1000件のURL
- **処理方式**: 順次処理／任意で並列処理（レート制限考慮）
- **並列設定**: `execution.parallel=true` と `execution.max_workers` で制御
- **メモリ使用量**: チャンク処理で最適化
- **実行時間**: 1000件で約8-10時間（順次処理時の目安）
- **注意事項**: 並列実行時は Google API クォータ消費が増加するため、小規模で挙動確認後に本番運用する

## 11. 設定パラメータ詳細

### 11.1 API設定
```yaml
api:
  key: "${PSI_API_KEY}"  # PSI APIキー
  timeout: 60            # リクエストタイムアウト（秒）
  retry_count: 3         # リトライ回数
  base_delay: 1          # 基本遅延時間（秒）
  max_delay: 60          # 最大遅延時間（秒）
```

### 11.2 入力設定
```yaml
input:
  targets_csv: "./targets.csv"  # 計測対象CSVファイルパス
  csv_encoding: "utf-8-sig"     # CSVエンコーディング
```

### 11.3 出力設定
```yaml
output:
  json_dir: "./output/json"                    # JSON出力ディレクトリ
  csv_file: "./output/csv/psi_metrics.csv"     # CSV出力ファイル
  log_file: "./logs/execution.log"             # ログファイル
  timestamp_format: "%Y%m%d_%H%M%S"            # タイムスタンプ形式
```

### 11.4 実行設定
```yaml
execution:
  strategies: ["mobile", "desktop"]  # 計測戦略
  parallel: false                     # 並列実行（必要に応じて true ）
  max_workers: 4                      # 並列時の最大ワーカー数
```

### 11.5 ログ設定
```yaml
logging:
  level: "INFO"                                        # ログレベル
  format: "%(asctime)s [%(levelname)s] %(message)s"    # ログ形式
  max_file_size: "10MB"                               # 最大ファイルサイズ
  backup_count: 5                                     # バックアップ数
```

## 12. データ形式仕様

### 12.1 CSV入力形式（targets.csv）
```csv
url,name,enabled,category,priority
https://www.example.com,サンプルサイト,true,企業サイト,high
```

**カラム仕様:**
- `url` (必須): 計測対象URL（http/https）
- `name` (必須): サイト名（結果ファイルで使用）
- `enabled` (オプション): 計測有効/無効（デフォルト: true）
- `category` (オプション): サイトカテゴリ（任意分類）
- `priority` (オプション): 優先度（high/medium/low）

### 12.2 CSV出力形式（psi_metrics.csv）
```csv
site_name,url,strategy,timestamp,onload_ms,ttfb_ms,lcp_ms,cls,speed_index_ms,category,priority
```

**データ型:**
- `*_ms`: 数値（ミリ秒）
- `cls`: 数値（0-1の範囲）
- `timestamp`: ISO 8601形式
- その他: 文字列

## 13. 制限事項・注意事項

### 13.1 API制限
- PSI APIの1日あたりクォータ制限あり
- 連続実行時のレート制限（1分間に数回程度）
- 大量データ処理時は時間がかかる

### 13.2 計測条件の違い
- PSIとSplunk Syntheticは異なる条件で計測
- ネットワーク・地域・デバイス条件の差により数値に差が出る
- 傾向分析での使用を推奨

### 13.3 データ精度
- 計測値にはばらつきがある
- 複数回計測での平均値使用を推奨
- 異常値の除外処理が必要な場合がある

## 14. 運用ガイドライン

### 14.1 推奨実行頻度
- **日次監視**: 重要サイトのみ（10-50件）
- **週次監視**: 全サイト（100-1000件）
- **月次監視**: 詳細分析用

### 14.2 データ保管
- JSON: 詳細分析用（30日保管）
- CSV: 長期トレンド分析用（1年保管）
- ログ: トラブルシューティング用（30日保管）

### 14.3 アラート設定
- 実行失敗時のアラート
- APIクォータ使用量の監視
- 異常値検出時の通知

## 15. 今後の拡張予定

### 15.1 機能拡張
- Web Vitals の詳細分析
- 履歴データの蓄積・トレンド分析
- Splunk Synthetic データとの自動比較
- レポート生成機能

### 15.2 UI拡張
- Web UI での実行・結果確認
- ダッシュボード機能
- アラート設定UI

---

**最終更新**: 2025年10月13日
